/**********************************************************************************************************************
 * \file Auto_Door.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 * 
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of 
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and 
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all 
 * derivative works of the Software, unless such copies or derivative works are solely in the form of 
 * machine-executable object code generated by a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE 
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 *********************************************************************************************************************/


/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "Auto_Door.h"

#include "Headers.h"
#include "IfxPort.h"
#include "IfxPort_PinMap.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define btn_auto_lock_idx       0       // 오토락 버튼 상태 받아오기
#define btn_door_opcl_idx       1       // 차량문 열고 닫힘 버튼 상태 받아오기
#define btn_kids_lock_idx       2       // 차량 문잠금(키즈락) 버튼 상태 받아오기
#define btn_emergency_stop_idx  3       // 비상 정지 버튼 상태 받아오기

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
uint8 g_auto_lock = TRUE;
uint8 g_door_lock = LOCK;           // 수동 잠금 걸쇠.
uint8 g_door      = DOOR_CLOSE;     // 차량 문의 현재 상태.

boolean g_touch    = FALSE;
boolean g_finger   = FALSE;
boolean g_foot     = FALSE;
boolean g_obstacle = FALSE;

boolean g_state_change = FALSE;

boolean g_btns[4] = {FALSE, FALSE, FALSE, FALSE};        // 버튼들(4개)의 상태를 받아오는 배열

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/
void Setup(void);
void Auto_Door_Start(void);
void Sensors(void);
void Change_State(void);
void Actuators(void);
void Change_Door_State(void);
void Change_Auto_Lock_State(void);
void Change_Door_Lock_State(void);

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
void Auto_Door(void) {
    Setup();
    Auto_Door_Start();
}

void Setup(void) {
//    PIN_MODE(IfxPort_P00_4, INPUT_MODE);
    PIN_MODE(IfxPort_P14_0, OUTPUT_MODE);
    PIN_MODE(IfxPort_P15_6, OUTPUT_MODE);
    PIN_MODE(IfxPort_P00_8, OUTPUT_MODE);

    Init_Gtm();
    initGtmTom();
    Init_Vadc();
    Init_Finger_Detector();
    Init_Touch_Sensor();
    Init_Buttons();
//
    Init_Foot_Sensor();
    Init_Obstacle_Sensor();
//    Init_Uart();
    Start_Adc_Scan();

//    IfxPort_setPinModeOutput(IfxPort_P14_0, IfxPort_P14_0.pinIndex, mode, index);
}

void Auto_Door_Start() {
    while(1) {
        Sensors();
        Change_State();
        if (g_state_change == TRUE) {
            g_state_change = FALSE;
            continue;
        }
        Actuators();
    }
}

void Sensors(void) {
    // 오토락이 해제되어 있고, 터치 모듈을 눌러서 문을 열때.
    if ((g_auto_lock == FALSE) && (g_door == DOOR_CLOSE)) {
        g_touch = Read_Touch_Sensor();
    }
    else {
        g_touch = FALSE;
    }

    // 손끼임 검사
    if ((g_door == DOOR_CLOSING) || (g_door == DOOR_CLOSE)) {
        g_finger = Read_Finger_Detector();
    }
    else {
        g_finger = FALSE;
    }

    Read_Buttons(g_btns);   // 스위치값들 읽어오기.

//    g_btns[btn_auto_lock_idx]       = Get_Button_State(PIN_BTN_AUTO_LOCK);
//    g_btns[btn_door_opcl_idx]       = Get_Button_State(PIN_BTN_DOOR_OPCL);
//    g_btns[btn_kids_lock_idx]       = Get_Button_State(PIN_BTN_KIDS_LOCK);
//    g_btns[btn_emergency_stop_idx]  = Get_Button_State(PIN_BTN_EMERGENCY_STOP);

    if(g_btns[0] && !g_btns[1] && !g_btns[2]){
        IfxPort_setPinHigh(IfxPort_P14_0.port, IfxPort_P14_0.pinIndex);
        IfxPort_setPinLow(IfxPort_P15_6.port, IfxPort_P15_6.pinIndex);
        IfxPort_setPinLow(IfxPort_P00_8.port, IfxPort_P00_8.pinIndex);
    }
    else if(!g_btns[0] && g_btns[1] && !g_btns[2]){
        IfxPort_setPinLow(IfxPort_P14_0.port, IfxPort_P14_0.pinIndex);
        IfxPort_setPinHigh(IfxPort_P15_6.port, IfxPort_P15_6.pinIndex);
        IfxPort_setPinLow(IfxPort_P00_8.port, IfxPort_P00_8.pinIndex);
    }
    else if(!g_btns[0] && !g_btns[1] && g_btns[2]){
        IfxPort_setPinLow(IfxPort_P14_0.port, IfxPort_P14_0.pinIndex);
        IfxPort_setPinLow(IfxPort_P15_6.port, IfxPort_P15_6.pinIndex);
        IfxPort_setPinHigh(IfxPort_P00_8.port, IfxPort_P00_8.pinIndex);
    }
    else{
        IfxPort_setPinLow(IfxPort_P14_0.port, IfxPort_P14_0.pinIndex);
        IfxPort_setPinLow(IfxPort_P15_6.port, IfxPort_P15_6.pinIndex);
        IfxPort_setPinLow(IfxPort_P00_8.port, IfxPort_P00_8.pinIndex);
    }

    Delay_Ms(10);

    // 발 감지 초음파
    if ((g_door == DOOR_CLOSE) && (g_auto_lock == FALSE)) {
        g_foot = Read_Foot_Detection_State();
    }
    else {
        g_foot = FALSE;
    }

    // 차량 문의 장애물 감지 초음파
    // g_door == DOOR_CLOSE 또는 g_door == DOOR_OPEN일 때?
    if ((g_door == DOOR_OPENING)) {
        g_obstacle = Read_Obstacle_Detection_State();
    }
    else {
        g_obstacle = FALSE;
    }

    Delay_Ms(10);
}

void Change_State(void) {
    Change_Door_State();
    Change_Auto_Lock_State();
    Change_Door_Lock_State();
}


void Change_Auto_Lock_State(void) {
    // Auto_Lock은 반드시 차량 문이 닫혀 있는 상태에서만 동작해야한다.
    if (g_door != DOOR_CLOSE) {
        return;
    }

    // if (버튼 기능 잠금 해제) || (uart 기능 잠금 해제)
    if(g_btns[btn_auto_lock_idx])
    {g_auto_lock = (g_auto_lock == TRUE) ? FALSE : TRUE;}
}

void Change_Door_Lock_State(void) {
    // 수동 잠금도 반드시 차량 문이 닫혀있는 상태에서만 동작해야한다.
    if (g_door != DOOR_CLOSE) {
        return;
    }

    switch (g_door_lock) {
        case LOCK:
            // if (버튼 잠금 해제) || g_auto_lock == FALSE)
            if(g_auto_lock == FALSE && g_btns[btn_kids_lock_idx])
            {g_door_lock = UNLOCKING;}
            break;
        case UNLOCK:
            // if (버튼 잠금)
            if(g_btns[btn_kids_lock_idx])
            {g_door_lock = LOCKING;}
            break;
        case LOCKING:
        case UNLOCKING:
        default:
            break;
    }
}

void Change_Door_State(void) {
    // auto_lock이 해제가 안되어 있을 떄는 아무것도 할 수 없다. state 변경 없음.
    if (g_auto_lock == TRUE) {
        return;
    }

    // 수동 잠금 걸쇠
    if (g_door_lock != UNLOCK) {
        return;
    }

    switch (g_door) {
        case DOOR_OPEN:
            // if (uart 닫기 || 버튼 닫기)
            if(g_btns[btn_door_opcl_idx])
            {g_door = DOOR_CLOSING; g_state_change = TRUE;}
            break;
        case DOOR_CLOSE:
            // 문이 잠긴 상황에서 열기 버튼을 누르면 자동 잠금 해제 후 열기?
            // if (uart 열기 || 버튼 열기) && 기능 가능 && 문 잠기지 않음
            if(g_btns[btn_door_opcl_idx] && (g_auto_lock == FALSE) && (g_door_lock == UNLOCK))
            {g_door = DOOR_OPENING; g_state_change = TRUE;}
            break;
        case DOOR_OPENING:
            // if ((장애물 && 손안끼임) || 비상 정지 버튼 멈춤)
            if((g_obstacle && (!g_finger)) || g_btns[btn_emergency_stop_idx])
            {g_door = DOOR_STOP; g_state_change = TRUE;}
            // 문이 완전히 닫힌경우의 상태 천이는 Side_Door.c 에 정의되어 있음.
            break;
        case DOOR_CLOSING:
            if(g_finger) //(손가락)
            {g_door = DOOR_OPENING; g_state_change = TRUE;}
            else if(g_btns[btn_emergency_stop_idx]) //(버튼 멈춤)
            {g_door = DOOR_STOP; g_state_change = TRUE;}
//            // else if //(끝까지 도달)
//            {g_door = DOOR_CLOSE; g_state_change = TRUE;}
            break;
        case DOOR_STOP:
            // 문 버튼으로 닫고 싶은 경우?
            // if (문 버튼 || uart 열기)
            if(g_btns[btn_door_opcl_idx])
            {g_door = DOOR_OPENING; g_state_change = TRUE;}
            // else if (uart 닫기)
            {g_door = DOOR_CLOSING; g_state_change = TRUE;}
            break;
        default:
            break;
        }
}

void Actuators(void) {
//    Control_Door_Lock(&g_door_lock);

    if (g_auto_lock == FALSE && g_door_lock == UNLOCK) {
        Control_Door(&g_door);
    }
//    Control_Audio();
}
